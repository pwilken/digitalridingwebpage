<?xml version="1.0" encoding="UTF-8" ?>

<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
   
      <title></title>
   
   <link>https://digitalriding.de</link>
   <description>go down for deep diving into...</description>
   <language>de-ge</language>
   <managingEditor> </managingEditor>
   <atom:link href="rss" rel="self" type="application/rss+xml" />
   
	<item>
	  <title>Server Hardening - SSH</title>
	  <link>//Server-Hardening-SSH</link>
	  <author></author>
	  <pubDate>2018-10-12T15:50:00+00:00</pubDate>
	  <guid>//Server-Hardening-SSH</guid>
	  <description><![CDATA[
	     <p>Mietest du einen Server? Wenn ja, hast du ihn so eingerichtet, dass du dir sicher sein kannst, dass nur befugte Personen zugreifen können? Was ist wenn ich dir erzähle, dass ständig jemand versucht über Brute-Force dein SSH Login zu erhalten? Das ganze kann man ganz leicht selber nachprüfen</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ tail -f /var/auth.log
</code></pre></div></div>
<p>und einfach mal für eine kurze Zeit beobachten.</p>

<p>Viele Leute scheren sich nicht das initiale Passwort zu ändern, einen neuen Benutzer anzulegen oder SSH angemessen zu konfigurieren. Wundern sollte man sich dann allerdings nicht, wenn man nach einiger Zeit nicht mehr auf den Server zugreifen kann.</p>

<h2 id="was-ist-diese-secure-shell">Was ist diese Secure Shell?</h2>
<p>Es ist ein Netzwerkprotokoll, was auf TCP aufbaut. Es wird benutzt, um eine verschlüsselte Verbindung zu einem Server herzustellen. Die Shell eines entfernten Computers steht einem somit zur Verfügung. Implementiert ist das ganze als klassisches Client - Server Modell.</p>

<h2 id="wie-es-nicht-sein-sollte">Wie es nicht sein sollte</h2>
<p>Man bekommt von seinem Anbieter den Benutzer und das Passwort mitgeteilt, um sich über SSH anzumelden. Der Benutzer ist in der Regel root.</p>

<p>Diese Anmeldeinformationen sollte man allerdings nur bei der ersten Anmeldung nutzen.</p>

<blockquote>
  <p>Das ist genauso wie den Internet Explorer zu benutzen, um einen anderen Browser herunterzuladen.</p>
</blockquote>

<h2 id="der-übermächtige-root">Der übermächtige root</h2>
<p>Es ist keine gute Idee ständig als root unterwegs zu sein. Der root Benutzer hat jegliche Rechte auf dem System und so kann es mal schnell vorkommen, dass man irgendein Befehl oder Befehlskette ausführt die dir deinen Server zerschießen.</p>

<p>Deshalb ist es keine schlechte Idee einen neuen Benutzer anzulegen!</p>

<h2 id="ein-neuer-benutzer">Ein neuer Benutzer</h2>
<p>Da wir also nicht ständig als root unterwegs sein wollen, erstellen wir uns einen neuen Benutzer.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ adduser username
</code></pre></div></div>

<p>Eben ein Passwort festlegen und voilà, der neue Benutzer existiert.</p>

<p>Um unseren neuen Benutzer zu ermöglichen Programme zu nutzen, die nur dem root zugeschrieben sind, muss folgendes geschehen</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ usermod -aG sudo username
</code></pre></div></div>

<p>Wir können nun zum neu angelegten Benutzer wechseln</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ su - username
</code></pre></div></div>

<h2 id="schlüsselpaar-generieren">Schlüsselpaar Generieren</h2>

<p>Es werden zwei Schlüssel generiert. Ein öffentlicher und ein privater Schlüssel. Der öffentliche Schlüssel befindet sich nachher auf dem Server. Der private Schlüssel befindet sich auf der Maschine, von wo du dich aus mit dem Server verbindest.</p>
<blockquote>
  <p>An dieser Stelle sollte darauf hingewiesen werden, dass der private Schlüssel nur <strong>dir</strong> bekannt sein sollte.</p>
</blockquote>

<h4 id="linuxunix">Linux/Unix</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ssh-keygen -b 4096
</code></pre></div></div>

<p>Mit 4096 Bit gehen wir mal auf Nummer sicher.  Im anschließenden Dialog wirst du gefragt, ob du ein Passwort festlegen möchtest. Das ist an dieser Stelle dir selbst überlassen.</p>

<h4 id="windows">Windows</h4>
<p>Wenn das Windows Subsystem for Linux (WSL) aktiviert oder Cygwin installiert ist, dann läuft das Prozedere wie im <a href="#linuxunix">Linux/Unix</a> Abschnitt ab. Falls nicht kann ein graphisches Programm wie PuTTYgen verwendet werden.</p>

<h2 id="keys-übertragen">Keys Übertragen</h2>
<p>Der öffentliche Schlüssel muss zum Server übertragen werden. Das kann auf zwei Arten geschehen, wovon die erste aufgezeigte komfortabler ist.</p>

<p><em>Nr 1.</em></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ssh-copy-id username@server_ip
</code></pre></div></div>

<p><em>Nr 2.</em>
Den Inhalt des öffentlichen Schlüssels in den Zwischenspeicher packen</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ssh username@server_ip
$ nano ./ssh/authorized_keys
</code></pre></div></div>
<p>und dann am Besten ans untere Ende in einer neuen Zeile einfügen.</p>

<blockquote>
  <p>Falls das Verzeichnis <code class="highlighter-rouge">.ssh</code> und die Datei <code class="highlighter-rouge">authorized_keys</code> nicht existieren, dann kann man sie per Hand anlegen.</p>
</blockquote>

<p>Wenn bei der erneuten Anmeldung über SSH die Passwortabfrage entfällt, hat das ganze funktioniert.</p>

<h2 id="ssh-konfigurationsdatei">SSH Konfigurationsdatei</h2>
<p>Konfigurationsdateien von Diensten befinden sich bei unixoide System im Verzeichnis <code class="highlighter-rouge">/etc</code>. In unserem Falle passen wir die <code class="highlighter-rouge">/etc/ssh/sshd.config</code> an.</p>

<p>Bevor wir die Datei anpassen, bitte ich darum, dass eine Kopie angelegt wird.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo cp /etc/ssh/sshd.config /etc/ssh/sshd.config.bak
</code></pre></div></div>

<h3 id="konfiguration">Konfiguration</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo nano /etc/ssh/sshd.conf 
</code></pre></div></div>

<p>Damit wird die neuere Version des Protokolls benutzen</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Protocol 2
</code></pre></div></div>

<p>Als root sollte man sich nicht mehr über SSH anmelden sollen, denn das ist der naheliegendste Benutzern, den ein Angreifer benutzt, um sich einzuwählen.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PermitRootLogin no
</code></pre></div></div>

<p>Hat das mit den Schlüsseln funktioniert? Dann sollte auf ein Passwort verzichtet werden. Damit fällt einer der größten Angriffsvektoren raus.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PasswordAuthentication no 
</code></pre></div></div>

<p>Nur der Benutzer, den du im Abschnitt <a href="#ein-neuer-benutzer">Ein neuer Benutzer</a> erstellt hast, darf sich über SSH einloggen.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AllowUser username
</code></pre></div></div>

<p>Nachdem alle Anpassungen vorgenommen werden, muss der SSH Dienst neu gestartet werden. So gehts beispielsweise unter Ubuntu</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo systemctl reload sshd
</code></pre></div></div>

<h2 id="ssh-port">SSH Port</h2>
<p>Der Port des SSH Servers kann geändert werden. Das geschieht ebenfalls in der Konfigurationsdatei. Man könnte an dieser Stelle denken, dass man dem Angreifer damit ein Strich durch die Rechnung macht. Allerdings muss an dieser Stelle festgehalten werden, dass das faktisch nicht viel bringt.</p>

<p>Es ist trivial standardisierte Dienste  zu ermitteln und das zeigt z.B. ein einfacher Port Scan mit <code class="highlighter-rouge">nmap</code>.</p>

<p>Wenn man sich über einen TCP Client mit einem Server verbindet, worauf ein SSH Dienst läuft, erhält man so eine Antwort.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ nc sdf.org 22
$ SSH-2.0-OpenSSH_7.1
</code></pre></div></div>
<blockquote>
  <p>Das ist der Protokoll Anfang, in dem der Server dem Client mitteilt, welche SSH Protokoll Version  benutzt wird, um im folgenden weiter zu kommunizieren.</p>
</blockquote>

<h2 id="zusätzliche-absicherung-mit-fail2ban">Zusätzliche Absicherung mit Fail2Ban</h2>
<p>Mit diesem tollen Programm kann man die IP von unerwünschte Gäste automatisch sperren lassen, die innerhalb eines festgelegten Zeitintervalls eine Anzahl an Anmeldeversuchen überschritten haben.</p>

<h3 id="installation">Installation</h3>
<p>Unter Debian Distributionen</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo apt install fail2ban
</code></pre></div></div>

<h3 id="konfiguration-1">Konfiguration</h3>
<p>Wieder sollte eine Kopie angelegt werden, bevor wir etwas anpassen.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
</code></pre></div></div>

<p>Die <code class="highlighter-rouge">jail.local</code> überschreibt jegliche Werte, die in der <code class="highlighter-rouge">jail.conf</code> definiert sind. Diese sollte verwendet werden, um Anpassungen vorzunehmen</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo nano /etc/fail2ban/jail.local
</code></pre></div></div>

<p>Es ist existiert schon ein SSH Filter. Dieser muss nur noch aktiviert werden.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[sshd]
enabled=true
</code></pre></div></div>

<p>Nachdem alle Anpassungen vorgenommen werden, muss der fail2ban Dienst neu gestartet werden. So gehts beispielsweise unter Ubuntu</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo systemctl restart fail2ban
</code></pre></div></div>
<p>Jetzt zurücklehnen und einfach beobachten</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo tail -f /var/log/fail2ban.log
</code></pre></div></div>

<p>Vielleicht wäre es noch ganz interessant zu wissen, wie man gebannte IPs einsehen kann</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo cat /var/log/fail2ban.log | grep Ban
</code></pre></div></div>

<h2 id="ende">Ende</h2>
<p>Ich hoffe du konntest einiges aus diesem Blog Artikel mitnehmen. In Zukunft solltest du besser gewappnet sein :-)</p>

	  ]]></description>
	</item>


</channel>
</rss>
